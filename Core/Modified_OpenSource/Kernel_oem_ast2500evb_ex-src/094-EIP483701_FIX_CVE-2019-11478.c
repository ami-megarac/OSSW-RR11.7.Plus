diff -Naur linux.old/include/uapi/linux/snmp.h linux.new71/include/uapi/linux/snmp.h
--- linux.old/include/uapi/linux/snmp.h	2019-07-10 16:00:06.220799728 +0800
+++ linux.new71/include/uapi/linux/snmp.h	2019-07-10 15:56:18.894508572 +0800
@@ -259,6 +259,7 @@
 	LINUX_MIB_TCPSPURIOUS_RTX_HOSTQUEUES, /* TCPSpuriousRtxHostQueues */
 	LINUX_MIB_BUSYPOLLRXPACKETS,		/* BusyPollRxPackets */
 	LINUX_MIB_TCPAUTOCORKING,		/* TCPAutoCorking */
+	LINUX_MIB_TCPWQUEUETOOBIG,		/* TCPWqueueTooBig */
 	__LINUX_MIB_MAX
 };
 
diff -Naur linux.old/net/ipv4/proc.c linux.new71/net/ipv4/proc.c
--- linux.old/net/ipv4/proc.c	2019-07-10 16:00:32.968133410 +0800
+++ linux.new71/net/ipv4/proc.c	2019-07-10 15:56:18.918507965 +0800
@@ -280,6 +280,7 @@
 	SNMP_MIB_ITEM("TCPSpuriousRtxHostQueues", LINUX_MIB_TCPSPURIOUS_RTX_HOSTQUEUES),
 	SNMP_MIB_ITEM("BusyPollRxPackets", LINUX_MIB_BUSYPOLLRXPACKETS),
 	SNMP_MIB_ITEM("TCPAutoCorking", LINUX_MIB_TCPAUTOCORKING),
+	SNMP_MIB_ITEM("TCPWqueueTooBig", LINUX_MIB_TCPWQUEUETOOBIG),
 	SNMP_MIB_SENTINEL
 };
 
diff -Naur linux.old/net/ipv4/tcp_output.c linux.new71/net/ipv4/tcp_output.c
--- linux.old/net/ipv4/tcp_output.c	2019-07-10 16:00:47.275777373 +0800
+++ linux.new71/net/ipv4/tcp_output.c	2019-07-10 15:56:18.922507863 +0800
@@ -1084,6 +1084,11 @@
 	nsize = skb_headlen(skb) - len;
 	if (nsize < 0)
 		nsize = 0;
+	
+	if (unlikely((sk->sk_wmem_queued >> 1) > sk->sk_sndbuf)) {
+		NET_INC_STATS(sock_net(sk), LINUX_MIB_TCPWQUEUETOOBIG);
+		return -ENOMEM;
+	}	
 
 	if (skb_unclone(skb, GFP_ATOMIC))
 		return -ENOMEM;
